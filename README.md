# NGINX-RTMP 

Докер контейнер для nginx-rtmp

## Установка

Установка производится утилитой docker-compose

`docker-compose up -d --build nginx-server`

## Конфигурации

80 порт - порт по умолчанию  
443 порт - порт https  
1935 порт - внутренний порт для трансляции rtmp

## Переменные и секреты

| Имя переменной  | Тип        | Назначение
| --------------- | ---------- | ----------------------------------- |
| DOCKER_TOKEN    | Секрет     | Токен доступа в докер репозиторий   |
| SSH_KEY         | Секрет     | Кюч авторизации на сервере          |
| SSL_CERT        | Секрет     | Сертификат сайта                    |
| SSL_KEY         | Секрет     | Ключ сайта                          |
| DOCKER_REGISTRY | Переменная | Имя юзера/имя репозитория DockerHub |
| DOCKER_TAG      | Переменная | Имя тэга образа (имя сервиса)       |
| DOCKER_USER     | Переменная | Пользователь Dockerhub              |
| SSH_HOST        | Перменная  | Хост для деплоя                     |
| SSH_USER        | Перменная  | Пользователь для деплоя             |
| SSL_CERT_PATH   | Переменная | Путь для сохранения сертификата     |
| SSL_KEY_PATH    | Переменная | Путь для сохранения ключа           |
| WORKDIR         | Переменная | Директория для деплоя               |

## Настройка удаленной машины для деплоя 

Условия:
- установлен docker
- установлен docker-compose

Создание отдельно пользователя $SSH_USER на удаленной машине:  
`useradd $SSH_USER`  

Выдача прав владельца на папку пользователя  
`sudo chown -R $SSH_USER: /home/$SSH_USER/*`  

Создание ключа  (выполнять от лица пользователя, который ответственен за деплой)
`ssh-keygen -t rsa -b 4096`  

Запись ключа в файл  
`cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys`  

Проверка ключа, он же понадобится в переменной $SSH_KEY*
`cat ~/.ssh/id_rsa`  

На самой машине добавить пользователю права на докер  
`sudo chown $SSH_USER /var/run/docker.sock`  

Внутри папки `/home/$SSH_USER/` , создать папку $WORKDIR куда будет производиться установка проекта

###

*Добавить `id_rsa` потребуется именно в СЕКРЕТЫ т.к. в vars будет нарушена структура файла  



